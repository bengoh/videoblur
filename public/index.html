<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <style>
      body {
        background: black;
        color:#CCCCCC; 
      }
      .layered {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        height: 100%;
        min-height: 100%;
        line-height: 100%;
      }

      .layered canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        max-height: 100%;
      }

      .layered #video {
        display: inline;
        position: absolute;
        z-index: 100;
        top: 50%;
        left: 50%;
        transform: translateX(-50%) translateY(-50%);
        width: 100%;
        max-height: 100%;
      }

      #lower {
        z-index: 1;
      }

      #upper {
        z-index: 2;
      }

    </style>
    <script type="text/javascript" src="StackBlur.js"></script>
  </head>



  <body>
    <div class="layered">
      <video id="video" src="sample.mp4" controls="true"></video>
      <canvas id="upper"></canvas>
      <canvas id="lower"></canvas>
    </div>
  </body>

  <script type="text/javascript">

    const fadescreen = (video, lower, upper) => {
      const lastCapture = {
        videoTime: undefined,
        upperCap: undefined,
        lowerCap: undefined,
        realTime: undefined // KIV
      };

      const offscreen = document.createElement('canvas');

      let width, height;

      function captureFrame() {
        const targetWidth = upper.width;
        const targetHeight = upper.height;
        drawImage(video, offscreen, targetWidth, targetHeight);
        return offscreen.getContext('2d').getImageData(0, 0, width, height);
      }

      function drawLower(imageData) {
        lower.getContext('2d').putImageData(imageData, 0, 0);
        // drawImage(imageData, lower, width, height);
        stackBlur(lower, 20, false);
      }

      function drawUpper(imageData) {
        upper.getContext('2d').putImageData(imageData, 0, 0);
        // drawImage(imageData, upper, width, height);
        stackBlur(upper, 20, false);
      }

      video.addEventListener('play', () => {
        width = video.videoWidth;
        height = video.videoHeight;
        offscreen.width = width;
        offscreen.height = height;
        lastCapture.videoTime = video.currentTime;
        lastCapture.realTime = Date.now();
        lastCapture.lowerCap = captureFrame();
        drawLower(lastCapture.lowerCap);
      });

      video.addEventListener('timeupdate', ({ target: { currentTime } }) => {
        if (currentTime - lastCapture.videoTime > 5) {
          // 5 seconds have passed, make a new capture
          lastCapture.lowerCap = lastCapture.upperCap || lastCapture.lowerCap;
          lastCapture.upperCap = captureFrame();
          lastCapture.videoTime = currentTime;
        }

        // draw and shade all layers as appropriate
        lastCapture.lowerCap && drawLower(lastCapture.lowerCap);
        lastCapture.upperCap && drawUpper(lastCapture.upperCap);
        upper.style.opacity = Math.max(0, Math.min(1, (video.currentTime - lastCapture.videoTime) / 5));
      });
    }

    fadescreen(
      document.getElementById('video'),
      document.getElementById('lower'),
      document.getElementById('upper')
    );
  </script>   

 
</html>
